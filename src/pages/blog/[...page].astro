---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import Headline from "../../components/ui/Headline.astro";
import PostItem from "../../components/blog/PostItem.astro";
import type { GetStaticPathsOptions } from "astro";

export async function getStaticPaths({ paginate }: GetStaticPathsOptions) {
    const blogEntries = await getCollection("blog");
    const sortedPosts = blogEntries
        .filter((post) => post.data && post.data.pubDate)
        .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

    return paginate(sortedPosts, { pageSize: 100 });
}

const { page } = Astro.props;
const allPosts = page.data;

// Group posts by category/technology
const groupedPosts = allPosts.reduce((acc, post) => {
    const category = post.data.category || "General";
    if (!acc[category]) {
        acc[category] = [];
    }
    acc[category].push(post);
    return acc;
}, {} as Record<string, typeof allPosts>);

// Sort categories and posts within each category by date
const sortedCategories = Object.keys(groupedPosts).sort();

const metadata = {
    title: "Blog",
    description: "Technical insights on Databricks, GCP, AWS, Azure, Snowflake, and cloud architecture.",
};
---

<BaseLayout metadata={metadata}>
    <section class="relative px-4 py-8 sm:px-6 lg:px-8 md:py-12">
        <div class="relative mx-auto max-w-7xl">
            <Headline
                tagline="Blog"
                title="Technical Insights"
                subtitle="Articles on cloud architecture, data platforms, and modern technologies."
                classes={{
                    container: "mb-12 text-center",
                    title: "font-heading mb-4 text-4xl font-bold tracking-tight text-foreground md:text-5xl",
                    subtitle: "mx-auto max-w-3xl text-xl text-muted-foreground",
                }}
            />

            {sortedCategories.map((category) => (
                <div class="mb-16">
                    <h2 class="text-3xl font-bold mb-6 text-gray-900 border-b-2 border-blue-500 pb-2 inline-block">
                        {category}
                    </h2>
                    <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3 mt-6">
                        {groupedPosts[category]
                            .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
                            .map((post) => <PostItem post={post} />)}
                    </div>
                </div>
            ))}
        </div>
    </section>
</BaseLayout>
